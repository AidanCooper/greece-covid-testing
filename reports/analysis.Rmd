---
title: "Greece COVID-19 Border Testing"
author: "Aidan Cooper"
date: "06/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(here)
library(ggtext)
library(mgcv)

theme_set(theme_classic())
# Set1: "#E41A1C" "#377EB8" "#4DAF4A" "#984EA3" "#FF7F00"
```

## Background and Data

Research paper: [Efficient and targeted COVID-19 border testing via reinforcement learning](https://www.nature.com/articles/s41586-021-04014-z_reference.pdf)

Data sources:

 * [Greece border testing](https://github.com/kimondr/EVA_Public_Data)
 * [Our World in Data - COVID-19](https://github.com/owid/covid-19-data/tree/master/public/data)


Load data set.

```{r greece_data, message=FALSE}
df <- read_csv(here("data", "greece_eva.csv")) %>%
  separate(epoch_dates, sep = "/", into = c("epoch_start", "epoch_end")) %>%
  select(-c(epoch, epoch_end)) %>%
  mutate(epoch_start = as.Date(epoch_start))
slice_sample(df, n=10)
```

There are 38 entry points, numbered from 1-41, with numbers 7, 32, and 35 not observed in the data.

```{r}
point_entry_nums <- str_split(unique(df$point_entry), pattern="_") %>% sapply(extract, 2) %>% as.numeric() %>% sort()
paste(c(length(point_entry_nums), "entry points:", point_entry_nums), collapse=" ")
df <- df %>% 
  mutate(point_entry = fct_relevel(point_entry, paste0("Entry_", point_entry_nums)))
```

Create a filtered version containing only countries with at least 100,000 arrivals.

```{r}
# identify countries with at least 100,000 arrivals in Greece
countries <- df %>% 
  select(c(country, numSchedArrivals)) %>% 
  group_by(country) %>% 
  summarise(n_arrivals = sum(numSchedArrivals)) %>% 
  filter(n_arrivals > 100000) %>% 
  pull(country)
df_100k <- df %>% filter(country %in% countries)
paste(c(length(countries), "countries have at least 100,000 arrivals in Greece:", countries), collapse=" ")
```

Heatmap.

```{r}
df_heatmap <- df_100k %>%
  select(country, point_entry, numSchedArrivals) %>%
  group_by(country, point_entry) %>% 
  summarise(n_arrivals = sum(numSchedArrivals)) %>% 
  group_by(country) %>% mutate(n_arrivals = n_arrivals / sum(n_arrivals) * 100) %>% 
  mutate(point_entry = str_split(point_entry, pattern="_") %>% sapply(extract, 2) %>% as.numeric())
f <- df_heatmap %>% ggplot(aes(x=country, y=point_entry, fill=n_arrivals)) + 
  geom_tile() +
  labs(
    title = "Distribution of entry points for each country",
    subtitle = paste(
      "The percentage of arrivals at each entry point varies considerably depending on the country"
    ),
    x = "Origin country",
    y = "Entry point number",
    fill = "% arrivals",
    caption = "© Aidan Cooper 2021 | www.aidancooper.co.uk"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_markdown(),
    plot.caption = element_text(hjust = 0, size = 8,  colour = "#222222"),
    axis.title.y = element_text(vjust = 2, size = 12),
    panel.grid.major = element_line(),
    panel.grid.minor = element_line()
  )
width <- 8
height <- width * 9 / 16
ggsave("../figures/entry_points_heatmap.png", width = width, height = height)
f
```

Entry points

```{r}
df_entry <- df %>%
  select(-c(country, epoch_start)) %>%
  group_by(point_entry) %>%
  summarise(across(everything(), list(sum))) %>%
  mutate(
    tests_per_1000arrival = numTestsPerformed_1 / numSchedArrivals_1 * 1000,
    positives_per_1000test = numPositivesFound_1 / numTestsPerformed_1 * 1000,
    n_arrivals = numSchedArrivals_1,
    n_tests = numTestsPerformed_1,
  ) %>%
  select(c("point_entry", "n_arrivals", "n_tests", "tests_per_1000arrival", "positives_per_1000test")) %>%
  arrange(desc(n_arrivals))
df_entry
```


The number of tests conducted on each day of the week is consistent across all days, but the number of arrivals is considerably higher on Thu-Sun. This means that the rate of testing is higher for Thu-Sun than for Mon-Wed.

```{r}
df_tests <- df %>%
  select(-c(country, point_entry)) %>%
  group_by(epoch_start) %>%
  summarise(across(everything(), list(sum))) %>%
  mutate(
    tests_per_1000arrival = numTestsPerformed_1 / numSchedArrivals_1 * 1000,
    positives_per_1000test = numPositivesFound_1 / numTestsPerformed_1 * 1000,
    n_arrivals = numSchedArrivals_1,
    n_tests = numTestsPerformed_1,
    weekday = lubridate::wday(epoch_start, week_start = 1) < 4
  ) %>%
  select(c("epoch_start", "n_arrivals", "n_tests", "tests_per_1000arrival", "positives_per_1000test", "weekday")) %>%
  arrange(epoch_start)
mod1 <- gam(tests_per_1000arrival ~ s(as.numeric(epoch_start), bs = "cs"), data = df_tests)
df_tests <- df_tests %>%
  mutate(
    gam = mod1$fitted.values,
    gam_percent_diff = (tests_per_1000arrival - gam) / tests_per_1000arrival * 100
  )
df_dow <- df_tests %>%
  ungroup() %>%
  mutate(day_of_week = lubridate::wday(epoch_start, label = TRUE, week_start = 1)) %>% 
  select(c("day_of_week", "gam_percent_diff", "n_arrivals", "n_tests")) %>%
  group_by(day_of_week) %>%
  summarise(
    mean_diff = mean(gam_percent_diff),
    total_arrivals = sum(n_arrivals),
    total_tests = sum(n_tests)
    )
df_dow
```
Plot the _tests per 1,000 arrivals_ throughout the study period.

```{r}
f <- ggplot(df_tests, aes(x = epoch_start, y = tests_per_1000arrival)) +
  geom_line() +
  geom_point(
    mapping = aes(colour = weekday)
  ) +
  geom_line(aes(y = gam), colour = "grey", linetype = "dashed", size = 1) +
  labs(
    title = "COVID-19 testing per 1,000 arrivals",
    subtitle = paste(
      "Testing increased significantly over time, with higher testing rates on ",
      "**<span style='color:#377EB8;'>Mon-Wed</span>** than ",
      "**<span style='color:#E41A1C;'>Thu-Sun</span>**"
    ),
    x = "",
    y = "Tests performed per 1,000 arrivals",
    caption = "© Aidan Cooper 2021 | www.aidancooper.co.uk"
  ) +
  guides(colour = "none") +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_markdown(),
    plot.caption = element_text(hjust = 0, size = 8,  colour = "#222222"),
    axis.title.y = element_text(vjust = 2, size = 12),
    panel.grid.major = element_line(),
    panel.grid.minor = element_line()
  ) +
  scale_color_brewer(palette = "Set1") +
  scale_x_date(date_breaks = "1 month", limits = as.Date(c("2020-08-01", "2020-11-01")))
width <- 8
height <- width * 9 / 16
ggsave("../figures/testing_over_time.png", width = width, height = height)
f
```


Our World in Data COVID-19 dataset.

```{r covid_data, message=FALSE}
df_covid <- read_csv(here("data", "owid-covid-data.csv")) %>%
  select(c(
    iso_code,
    location,
    date,
    total_cases_per_million,
    new_cases_smoothed_per_million,
    total_deaths_per_million,
    new_deaths_smoothed_per_million,
    weekly_icu_admissions_per_million,
    weekly_hosp_admissions_per_million,
    new_tests_smoothed_per_thousand,
    positive_rate,
    tests_per_case,
    total_vaccinations_per_hundred
  ))
```
